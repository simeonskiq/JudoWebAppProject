@using JudoApp.Data.Models
@using JudoApp.Web.ViewModels.Order
@model AddOrderFormModel

@{
    var cartItems = ViewData["CartItems"] as List<CartItem> ?? new List<CartItem>();
}

@{
    ViewData["Title"] = "Place Order";
}

<div class="container mt-5">

    <h2>Place Your Order</h2>

    <!-- Progress Steps -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between position-relative align-items-center">
                <div class="d-flex flex-column align-items-center">
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width:40px;height:40px;">
                        <i class="fas fa-user"></i>
                    </div>
                    <span class="mt-2">Personal Info</span>
                </div>
                <div class="d-flex flex-column align-items-center">
                    <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center" style="width:40px;height:40px;">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <span class="mt-2">Address</span>
                </div>
                <div class="d-flex flex-column align-items-center">
                    <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center" style="width:40px;height:40px;">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <span class="mt-2">Payment</span>
                </div>
                <div class="d-flex flex-column align-items-center">
                    <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center" style="width:40px;height:40px;">
                        <i class="fas fa-check"></i>
                    </div>
                    <span class="mt-2">Confirmation</span>
                </div>

                <div class="position-absolute" style="height:2px;background-color:#dee2e6;width:100%;top:20px;z-index:-1;"></div>
            </div>
        </div>
    </div>

    <!-- Form -->
    <form asp-action="Create" method="post" id="orderForm">
        <div class="row">
            <div class="col-12">

                <!-- Step 1: Personal Info -->
                <div id="step1" class="step-content">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5>Personal Information</h5>
                            <div class="mb-3">
                                <label asp-for="FirstName"></label>
                                <input asp-for="FirstName" class="form-control" required />
                                <span asp-validation-for="FirstName" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="LastName"></label>
                                <input asp-for="LastName" class="form-control" required />
                                <span asp-validation-for="LastName" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="Email"></label>
                                <input asp-for="Email" class="form-control" required/>
                                <span asp-validation-for="Email" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="PhoneNumber"></label>
                                <input asp-for="PhoneNumber" class="form-control" required />
                                <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                            </div>
                            <button type="button" class="btn btn-primary next-btn" data-next="2">Continue</button>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Address -->
                <div id="step2" class="step-content" style="display:none;">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5>Delivery Address</h5>
                            <div class="mb-3">
                                <label asp-for="Country"></label>
                                <input asp-for="Country" class="form-control" required />
                                <span asp-validation-for="Country" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="City"></label>
                                <input asp-for="City" class="form-control" required />
                                <span asp-validation-for="City" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="Address"></label>
                                <input asp-for="Address" class="form-control" required />
                                <span asp-validation-for="Address" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="PostalCode"></label>
                                <input asp-for="PostalCode" class="form-control" required />
                                <span asp-validation-for="PostalCode" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="ShippingMethod"></label>
                                <input asp-for="ShippingMethod" class="form-control" required />
                                <span asp-validation-for="ShippingMethod" class="text-danger"></span>
                            </div>
                            <button type="button" class="btn btn-primary next-btn" data-next="3">Continue</button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Payment + TotalAmount + OrderNotes -->
                <div id="step3" class="step-content" style="display:none;">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5>Payment</h5>
                            <div class="mb-3">
                                <label asp-for="PaymentMethod"></label>
                                <select asp-for="PaymentMethod" class="form-control" required>
                                    <option value="">Select...</option>
                                    <option value="Cash">Cash</option>
                                    <option value="Card">Card</option>
                                </select>
                                <span asp-validation-for="PaymentMethod" class="text-danger"></span>
                            </div>

                            <div class="mb-3">
                                <label asp-for="TotalAmount"></label>
                                <input asp-for="TotalAmount" class="form-control" required />
                                <span asp-validation-for="TotalAmount" class="text-danger"></span>
                            </div>

                            <div class="mb-3">
                                <label asp-for="OrderNotes"></label>
                                <textarea asp-for="OrderNotes" class="form-control"></textarea>
                                <span asp-validation-for="OrderNotes" class="text-danger"></span>
                            </div>

                            <button type="button" class="btn btn-primary next-btn" data-next="4">Continue</button>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Confirmation -->
                <div id="step4" class="step-content" style="display:none;">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5>Confirm Your Order</h5>

                            <div id="confirmationDetails" class="mb-3"></div>

                            <h6>Cart Items</h6>
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Price</th>
                                        <th>Qty</th>
                                        <th>Total</th>
                                    </tr>
                                <tbody>
                                    @foreach (var item in cartItems)
                                    {
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <img src="@(item.ImageUrl ?? item.Product?.ImageUrl ?? "/images/no-image.png")"
                                                         alt="product" style="width:60px;height:60px;object-fit:cover;margin-right:10px;" />
                                                    <div>
                                                        <div>@(item.Product?.Name ?? item.ProductName)</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>@(item.Price.ToString("C"))</td>
                                            <td>@item.Quantity</td>
                                            <td>@((item.Price * item.Quantity).ToString("C"))</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>

                            <button type="submit" class="btn btn-success">Confirm & Place Order</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Multi-step navigation
        document.querySelectorAll('.next-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                let nextStep = this.getAttribute('data-next');
                document.querySelectorAll('.step-content').forEach(s => s.style.display = 'none');
                document.getElementById('step' + nextStep).style.display = 'block';

                // Update progress bar
                document.querySelectorAll('.rounded-circle').forEach(c => {
                    c.classList.remove('bg-primary');
                    c.classList.add('bg-secondary');
                });
                document.querySelectorAll('.rounded-circle')[nextStep-1].classList.remove('bg-secondary');
                document.querySelectorAll('.rounded-circle')[nextStep-1].classList.add('bg-primary');

                // Build confirmation step
                if (nextStep == "4") {
                    let detailsHtml = `
                        <p><strong>First Name:</strong> ${document.getElementById("FirstName").value}</p>
                        <p><strong>Last Name:</strong> ${document.getElementById("LastName").value}</p>
                        <p><strong>Email:</strong> ${document.getElementById("Email").value}</p>
                        <p><strong>Phone:</strong> ${document.getElementById("PhoneNumber").value}</p>
                        <p><strong>Country:</strong> ${document.getElementById("Country").value}</p>
                        <p><strong>City:</strong> ${document.getElementById("City").value}</p>
                        <p><strong>Address:</strong> ${document.getElementById("Address").value}</p>
                        <p><strong>Postal Code:</strong> ${document.getElementById("PostalCode").value}</p>
                        <p><strong>Shipping Method:</strong> ${document.getElementById("ShippingMethod").value}</p>
                        <p><strong>Payment Method:</strong> ${document.getElementById("PaymentMethod").value}</p>
                        <p><strong>Total Amount:</strong> ${document.getElementById("TotalAmount").value}</p>
                        <p><strong>Order Notes:</strong> ${document.getElementById("OrderNotes").value}</p>
                    `;
                    document.getElementById("confirmationDetails").innerHTML = detailsHtml;
                }
            });
        });
    </script>
}
